% --------------------------------------------------------------------
\begin{tactic}{byphoare}
  \begin{tsyntax}{byphoare (_ : $\;P$ ==> $\;Q$)}
    If the goal's conclusion has the form
    \begin{center}
      \ec{Pr[$M$.$p$($a_1$, $\ldots$, $a_n$) @ &$m$ : $\;E$] = $\;e$},
    \end{center}
    reduce the goal to three subgoals:
    \begin{itemize}
    \item One with conclusion
      \ec{phoare[$M$.$p$ : $\;P$ ==> $\;Q$] = $\;e$};

    \item One whose conclusion says that $P$ holds, where
      variables references are looked-up in \ec{&$m$} and
      references to the formal parameters of \ec{$M$.$p$}
      have been replaced by its arguments; and

    \item One whose conclusion says that \ec{$Q$ <=> $\;E$}.
    \end{itemize}

    The argument to \ec{byphoare} may be replaced by a proof term for
    \ec{phoare[$M$.$p$ : $\;P$ ==> $\;Q$] = $\;e$}, in which case the
    first subgoal isn't generated.  Furthermore, either or both of $P$
    and $Q$ may be replaced by \ec{_}, asking that the pre- or
    postcondition be inferred.  Supplying no argument to \ec{byphoare}
    is the same as replacing both $P$ and $Q$ by \ec{_}.

    \medskip
    \emph{The other variants of the tactic behave similarly with
    regards to the use of proof terms and specification inference.}

    \medskip For example, consider the module
    \ecinput[linerange=3-9]{examps/tactics/byphoare/1.ec}
    If the current goal is
    \ecinput{examps/parts/tactics/byphoare/1-1.0.ec} then
    running \ecinput{examps/parts/tactics/byphoare/1-1.ec}
    produces the goals
    \ecinput{examps/parts/tactics/byphoare/1-1.1.ec}
    and
    \ecinput{examps/parts/tactics/byphoare/1-1.2.ec}
    and
    \ecinput{examps/parts/tactics/byphoare/1-1.3.ec}
    Given the lemma
    \ecinput[linerange=27-28]{examps/tactics/byphoare/1.ec}
    if the current goal is
    \ecinput{examps/parts/tactics/byphoare/1-2.0.ec} then
    running \ecinput{examps/parts/tactics/byphoare/1-2.ec}
    produces the goals
    \ecinput{examps/parts/tactics/byphoare/1-2.1.ec}
    and
    \ecinput{examps/parts/tactics/byphoare/1-2.2.ec}
  \end{tsyntax}

  \begin{tsyntax}{byphoare (_ : $\;P$ ==> $\;Q$)}
    If the goal's conclusion has the form
    \begin{center}
      \ec{$e$ <= Pr[$M$.$p$($a_1$, $\ldots$, $a_n$) @ &$m$ : $\;E$]},
    \end{center}
    then \ec{byphoare} behaves as in the first variant except
    the conclusion of the first subgoal is
    \ec{phoare[$M$.$p$ : $\;P$ ==> $\;Q$] >= $\;e$}.

    \medskip For example, if the current goal is
    \ecinput{examps/parts/tactics/byphoare/2-1.0.ec} then
    running \ecinput{examps/parts/tactics/byphoare/2-1.ec}
    produces the goals
    \ecinput{examps/parts/tactics/byphoare/2-1.1.ec}
    and
    \ecinput{examps/parts/tactics/byphoare/2-1.2.ec}
    and
    \ecinput{examps/parts/tactics/byphoare/2-1.3.ec}
    \fxfatal{It's confusing how the third goal has been simplified,
    but not pruned.}
    Given the lemma
    \ecinput[linerange=19-19]{examps/tactics/byphoare/2.ec}
    if the current goal is
    \ecinput{examps/parts/tactics/byphoare/2-2.0.ec} then
    running \ecinput{examps/parts/tactics/byphoare/2-2.ec}
    produces the goals
    \ecinput{examps/parts/tactics/byphoare/2-2.1.ec}
    and
    \ecinput{examps/parts/tactics/byphoare/2-2.2.ec}
    And, if the current goal is
    \ecinput{examps/parts/tactics/byphoare/2-3.0.ec} then
    running \ecinput{examps/parts/tactics/byphoare/2-3.ec}
    produces the goals
    \ecinput{examps/parts/tactics/byphoare/2-3.1.ec}
    and
    \ecinput{examps/parts/tactics/byphoare/2-3.2.ec}
    and
    \ecinput{examps/parts/tactics/byphoare/2-3.3.ec}
  \end{tsyntax}

  \begin{tsyntax}{byphoare (_ : $\;P$ ==> $\;Q$)}
    If the goal's conclusion has the form
    \begin{center}
      \ec{Pr[$M$.$p$($a_1$, $\ldots$, $a_n$) @ &$m$ : $\;E$] <= $\;e$},
    \end{center}
    then \ec{byphoare} behaves as in the first variant except
    the conclusion of the first subgoal is
    \ec{phoare[$M$.$p$ : $\;P$ ==> $\;Q$] <= $\;e$}.

    \medskip For example, if the current goal is
    \ecinput{examps/parts/tactics/byphoare/3-1.0.ec} then
    running \ecinput{examps/parts/tactics/byphoare/3-1.ec}
    produces the goals
    \ecinput{examps/parts/tactics/byphoare/3-1.1.ec}
    and
    \ecinput{examps/parts/tactics/byphoare/3-1.2.ec}
    and
    \ecinput{examps/parts/tactics/byphoare/3-1.3.ec}
    \fxfatal{It's confusing how the third goal has been simplified,
    but not pruned.}
    Given the lemma
    \ecinput[linerange=19-19]{examps/tactics/byphoare/3.ec}
    if the current goal is
    \ecinput{examps/parts/tactics/byphoare/3-2.0.ec} then
    running \ecinput{examps/parts/tactics/byphoare/3-2.ec}
    produces the goals
    \ecinput{examps/parts/tactics/byphoare/3-2.1.ec}
    and
    \ecinput{examps/parts/tactics/byphoare/3-2.2.ec}
    And, if the current goal is
    \ecinput{examps/parts/tactics/byphoare/3-3.0.ec} then
    running \ecinput{examps/parts/tactics/byphoare/3-3.ec}
    produces the goals
    \ecinput{examps/parts/tactics/byphoare/3-3.1.ec}
    and
    \ecinput{examps/parts/tactics/byphoare/3-3.2.ec}
    and
    \ecinput{examps/parts/tactics/byphoare/3-3.3.ec}
  \end{tsyntax}
\end{tactic}  

%%  \begin{tsyntax}{byphoare [option]? <spec>}
%%  Derives a probability relation from a \phl judgement on the
%%  procedure involved. \ec{<spec>} can include wildcards when the
%%  tactic should infer the pre or postcondition.
%%
%%  \textbf{Options:} By default, (\ec{eq} option) specification
%%  inference attempts to infer a conjunction of equalities sufficient
%%  to imply the desired relation. Passing the \ec{-eq} option
%%  overrides this behaviour, instead using the trivial relation on
%%  events.
%%
%%  \paragraph{Examples:}\strut
%%
%%  \begin{cmathpar}
%%    \texample
%%      {\ec{byphoare (_: P ==> Q)}}
%%      {\pHL{P}{f}{Q}{=}{\delta} \\
%%       P\ m[\Arg\mapsto\vec{a}] \\
%%       \forall \mem{m'}.\, Q\ m' \Leftrightarrow E\ m'}
%%      {\PR{f}{\vec{a}}{\mem{m}}{E} = \delta}
%%  \end{cmathpar}
%%  \end{tsyntax}
%%
%%  \begin{tsyntax}{byphoare <lemma>}
%%  Same as \ec{byphoare <spec>}, but the specification to use is
%%  inferred from the lemma provided. Raises an error if the lemma does
%%  not refer to the expected procedure. Inference options have no
%%  effect in this setting.
%%  \end{tsyntax}
%%\end{tactic}
