% !TeX root = easycrypt.tex
\chapter{Writing Proofs}

\section{Ambient Logic (Guillaume)}

%% TODO (Francois): For index, rather than \texttt, use \rawec and make a class of keywords for tactics and tacticals

\subsection{The \texttt{case} tactic}
\index{ambient}{case@\texttt{case}}
%

\subsection{The \texttt{unfold} tactic}
\index{ambient}{unfold@\texttt{unfold}}
%

\subsection{The \texttt{simplify} tactic}
\index{ambient}{simplify@\texttt{simplify}}
%

\subsection{The \texttt{trivial} tactic}
\index{ambient}{trivial@\texttt{trivial}}
%

\section{Program Logics (C\'esar)}

\subsection{Reasoning about random samplings: the \texttt{rnd} tactic}
%
\subsubsection{Hoare Logic}
\index{hoare}{Program Reasoning!rnd@\texttt{rnd}}

\subsubsection{Probabilistic Hoare Logic}
\index{phl}{Program Reasoning!rnd@\texttt{rnd}}
\Syntax 
\verb+rnd+ (\textit{formula} $|$ \_ ) (\textit{formula} $|$ \_ )

\Description
the first optional parameter $p$ is a computable predicate (i.e., \verb+'a cPred+)
(i.e., \verb+'a -> bool+ ). Assume $d$ of type \verb+A Distr.distr+. 
\begin{displaymath}
\begin{array}{c}
  \infrule{
    \hoareS{c}{\pre}{\mu\, d\, p \leq f \land 
      (\forall v\in \mathsf{support}(d).~ \post\subst{x}{v} \Rightarrow p\, v)}
  }{
    \bdHoareSle{c;\Rand{x}{d}}{\pre}{\post}{f}
  }\left[\verb+rnd+\ p\right]
\\[4ex]
\end{array}
\end{displaymath}
If $p$ is not given then the tool attempts to build it from $\post$
(not implemented yet).

For lower-bounded and exact probabilistic judgments the tactic
additionally accepts an optional parameter $g$ of type \verb+real+
representing a bound:
\begin{displaymath}
  \infrule{
    \bdHoareSge{c}{\pre}{\mu\, d\, p \geq g \land 
      (\forall v\in \mathsf{support}(d).~ p\, v \Rightarrow \post\subst{x}{v} )}{\frac{f}{g}} 
  }{
    \bdHoareSge{c;\Rand{x}{d}}{\pre}{\post}{f}
  }\left[\verb+rnd+\ p\ g\right]
\end{displaymath}
%
\begin{displaymath}
  \infrule{
    \bdHoareSeq{c}{\pre}{\mu\, d\, p = g \land 
      (\forall v\in \mathsf{support}(d).~ p\, v \Leftrightarrow \post\subst{x}{v} )}{\frac{f}{g}} 
  }{
    \bdHoareSeq{c;\Rand{x}{d}}{\pre}{\post}{f}
  }\left[\verb+rnd+\ p\ g\right]
\end{displaymath}
%
If $g$ is not given then $g=f$ in the rule.

\subsubsection{Relational Hoare Logic}
\index{prhl}{Program Reasoning!rnd@\texttt{rnd}}

\subsection{Reasoning about sequential composition: the \texttt{seq} tactic}
%
\subsubsection{Hoare Logic}
\index{hoare}{Program Reasoning!seq@\texttt{seq}}

\subsubsection{Probabilistic Hoare Logic}
\index{phl}{Program Reasoning!seq@\texttt{seq}}
\Syntax 
\verb+app+ \verb+[>>|<<]+ \textit{num} \textit{formula} (
[\textit{formula} \verb+|+ \textit{formula} \textit{formula}
\textit{formula} \textit{formula}]

\Description
Direction \verb+<<+ by default.
The first formula is the intermediate predicate.
Assume $s_2$ is at program position $n$.

For upper bounded judgments, the most general variant of the
\verb+app+ rule (i.e., when four bounds are given as parameters) implements the following rule:
\begin{displaymath}
  \infrule{
    \begin{array}{c}
      \bdHoareSle{s1}{P}{R}{f_1} \qquad \bdHoareSle{s2}{R}{Q}{f_2}
      \\
      \bdHoareSle{s1}{P}{R}{g_1} \qquad \bdHoareSle{s2}{R}{Q}{g_2}
      \\
      f_1 f_2 + g_1 g_2 \leq f 
    \end{array}
  }{
    \bdHoareSle{s1;s2}{P}{Q}{f}
  }
\end{displaymath}
%
If no argument is given then the following rule is applied:
\begin{displaymath}
  \infrule{
    \hoareS{s1}{P}{R} \qquad \bdHoareSle{s2}{R}{Q}{f}
  }{
    \bdHoareSle{s1;s2}{P}{Q}{f}
  }\left[\verb+app+\ n\ R\right]
\end{displaymath}
%
\warningbox{Which, if preferred, can be rewritten to:}
\begin{displaymath}
  \infrule{
    \hoareS{s1}{P}{\lambda m. \Prm{s_2}{m}{Q}\leq f} \qquad 
  }{
    \bdHoareSle{s1;s2}{P}{Q}{f}
  }\left[\verb+app+\ n\ R\right]
\end{displaymath}



For lower bounded and exact judgments, the app tactic implements the following rules

\begin{displaymath}
\begin{array}{c}
  \infrule{
    \bdHoareSge{s1}{P}{R}{f/g} \qquad \bdHoareSge{s2}{R}{Q}{g}
  }{
    \bdHoareSge{s1;s2}{P}{Q}{f}
  }\left[\verb+app+\ n\ R\ g\right]
\\[4ex]
  \infrule{
    \bdHoareSge{s1}{P}{R}{g} \qquad \bdHoareSge{s2}{R}{Q}{f/g}
  }{
    \bdHoareSge{s1;s2}{P}{Q}{f}
  }\left[\verb+app>>+\ n\ R\ g\right]
\end{array}
\end{displaymath}
%
The second parameter (optional) is a real number representing a bound (only supported for $=$ and $\geq$).
%
Similar rules hold for $=$. If the parameter $g$ is not given then
$g=f$ in the rule. 

\subsubsection{Relational Hoare Logic}
\index{prhl}{Program Reasoning!seq@\texttt{seq}}

\subsection{Reasoning about conditionals: the \texttt{if} tactic}
%
\subsubsection{Hoare and Probabilistic Hoare Logic}
\index{hoare}{Program Reasoning!if@\texttt{if}}
\index{phl}{Program Reasoning!if@\texttt{if}}
(similar to probabilistic Hoare \verb+if+ tactic)
\begin{displaymath}
\begin{array}{c}
  \infrule{
    \bdHoareSle{c_1}{\pre \land b}{\post}{f}\qquad
    \bdHoareSle{c_2}{\pre \land \neg b}{\post}{f}
  }{
    \bdHoareSle{\Cond{b}{c_1}{c_2}}{\pre}{\post}{f}
  }\left[\verb+if+ \right] 
\\[4ex]
\end{array}
\end{displaymath}
Similar rules hold for $=,\geq$.

\subsubsection{Relational Hoare Logic}
\index{prhl}{Program Reasoning!if@\texttt{if}}

\subsection{Computing weakest preconditions: the \texttt{wp} tactic}
%
\subsubsection{Hoare Logic}
\index{hoare}{Program Reasoning!wp@\texttt{wp}}

\subsubsection{Probabilistic Hoare Logic}
\index{phl}{Program Reasoning!wp@\texttt{wp}}
\Syntax \verb+wp+

\Description
Assuming \verb+wp+ complete (weakest) and $c$ is straight-line code,
$\bdHoareSeq{c}{\mathsf{wp}(c,\post)}{\post}{1}$, plus sequential
composition rule, we have:
\begin{displaymath}
  \infrule{
    \bdHoareSle{c_1}{\pre }{\mathsf{wp}(c_2,\post)}{f}
  }{
    \bdHoareSle{c_1;c_2}{\pre}{\post}{f}
  }\left[\verb+wp+ \right] 
\end{displaymath}
Similar rules hold for $=,\geq$.

\subsubsection{Relational Hoare Logic}
\index{prhl}{Program Reasoning!wp@\texttt{wp}}

\subsection{Concluding proofs of programs: the \texttt{skip} tactic}
\index{hoare}{Program Reasoning!skip@\texttt{skip}}
\index{phl}{Program Reasoning!skip@\texttt{skip}}
\index{prhl}{Program Reasoning!skip@\texttt{skip}}
%

\subsection{Simplifying conditionals: the \texttt{condt,condf} tactic}
%
\subsubsection{Probabilistic Hoare Logic}
\index{tactics}{probabilistic Hoare logic!condt@\texttt{condt}}
\index{tactics}{probabilistic Hoare logic!condf@\texttt{condf}}


\subsection{Reasoning about function calls: the \texttt{call} tactic}
%
\subsubsection{Hoare Logic}
\index{hoare}{Program Reasoning!call@\texttt{call}}
\Syntax \verb+call+ formula formula
\Description

Let $p$ stand for the formal parameters of function $f$, $\result_f$
the result variable of function $f$, and $\vec{m}$ the set of
variables modifiable by $f$.
\begin{displaymath}
  \infrule{
    \begin{array}{c}
      \hoareS{c}{\pre}{\pre_f\subst{\vec{p}}{\vec{y}} \land
        \forall v.~ \forall \vec{z}.~ 
        \post_f\subst{\result_f}{v}\subst{\vec{m}}{\vec{z}}
        \Rightarrow \post\subst{x}{v}\subst{\vec{m}}{\vec{z}}
      }
      \\[.5ex]
      \hoareS{f}{\pre_f}{\post_f}
    \end{array}
  }{
    \hoareS{c;\Call{x}{f}{\vec{y}}}{\pre}{\post}
  } \left[\verb+call+~ \pre_f~ \post_f \right]
\end{displaymath}



\subsubsection{Probabilistic Hoare Logic}
\index{phl}{probabilistic Hoare logic!call@\texttt{call}}

\Syntax \verb+call+ formula formula [formula]

\Description

Let $p$ stand for the formal parameters of function $f$, $\result_f$
the result variable of function $f$, and $\vec{m}$ the set of
variables modifiable by $f$.
\begin{displaymath}
  \infrule{
    \begin{array}{c}
      \hoareS{c}{\pre}{\pre_f\subst{\vec{p}}{\vec{y}} \land
        \forall v.~ \forall \vec{z}.~ 
        \post_f\subst{\result_f}{v}\subst{\vec{m}}{\vec{z}}
        \Rightarrow \post\subst{x}{v}\subst{\vec{m}}{\vec{z}}
      }
      \\[.5ex]
      \bdHoareSle{f}{\pre_f}{\post_f}{\delta}
    \end{array}
  }{
    \bdHoareSle{c;\Call{x}{f}{\vec{y}}}{\pre}{\post}{\delta}
  } \left[\verb+call+~ \pre_f~ \post_f \right]
\end{displaymath}

\begin{displaymath}
  \infrule{
    \begin{array}{c}
      \bdHoareSeq{c}{\pre}{\pre_f\subst{\vec{p}}{\vec{y}} \land
        \forall v.~ \forall \vec{z}.~ 
        \post_f\subst{\result_f}{v}\subst{\vec{m}}{\vec{z}}
        \Rightarrow \post\subst{x}{v}\subst{\vec{m}}{\vec{z}}}{\frac{\delta}{\delta'}}
    \\[.5ex]
    \bdHoareSeq{f}{\pre_f}{\post_f}{\delta'}
  \end{array}
  }{
    \bdHoareSeq{c;\Call{x}{f}{\vec{y}}}{\pre}{\post}{\delta}
  } \left[\verb+call+~ \pre_f~ \post_f~ \delta' \right]
\end{displaymath}

\begin{displaymath}
  \infrule{
    \begin{array}{c}
      \bdHoareSge{c}{\pre}{\pre_f\subst{\vec{p}}{\vec{y}} \land
        \forall v.~ \forall \vec{z}.~ 
        \post_f\subst{\result_f}{v}\subst{\vec{m}}{\vec{z}}
        \Rightarrow \post\subst{x}{v}\subst{\vec{m}}{\vec{z}}}
      {\frac{\delta}{\delta'}}
    \\[.5ex]
    \bdHoareSge{f}{\pre_f}{\post_f}{\delta'}
  \end{array}
  }{
    \bdHoareSge{c;\Call{x}{f}{\vec{y}}}{\pre}{\post}{\delta}
  } \left[\verb+call+~ \pre_f~ \post_f ~\delta' \right]
\end{displaymath}

If no parameter is given for the lower-bounded and exact judgements
then $\delta'=1$.

\warningbox{New tactics, needs structuring.}

\subsection{: the \texttt{hoare,hoare\_bd,pr\_bounded,bd\_eq}}

\subsubsection{Possibilistic and probabilistic Hoare Logic}
\Syntax \verb+hoare+, \verb+hoare_bd+
allows to switch between possibilistic and probabilistic logics
according to these rules:
\begin{displaymath}
\begin{array}{cc}
\infrule{
  \hoareS{c}{\pre}{\neg \post} \quad f = 0
}{
  \bdHoareSeq{c}{\pre}{\post}{f}
}
&
\infrule{
  \bdHoareSeq{c}{\pre}{\neg\post}{0}
}{
  \hoareS{c}{\pre}{\post}
}
\end{array}
\end{displaymath}

\Syntax \verb+pr_bounded+
discharges goals by applying trivial probability properties:
\begin{displaymath}
\begin{array}{cc}
\infrule{
}{
  \bdHoareSle{c}{\pre}{\post}{1}
}
&
\infrule{
}{
  \bdHoareSge{c}{\pre}{\post}{0}
}
\end{array}
\end{displaymath}

\Syntax \verb+bd_eq+
\begin{displaymath}
\begin{array}{cc}
\infrule{
  \bdHoareSeq{c}{\pre}{\post}{f}
}{
  \bdHoareSle{c}{\pre}{\post}{f}
}
&
\infrule{
  \bdHoareSeq{c}{\pre}{\post}{f}
}{
  \bdHoareSge{c}{\pre}{\post}{f}
}
\end{array}
\end{displaymath}




%***** NOT IMPLEMENTED 

\warningbox{The rest of this section describes tactics that are not yet implemented.}

\subsection{Reasoning about loops: the \texttt{while} tactic}
%
\subsubsection{Probabilistic Hoare Logic}
\index{phl}{Program Reasoning!while@\texttt{while}}

\Syntax \verb+while+ \textit{formula} \textit{formula} 
[\textit{formula} \textit{formula}]
%

\Description
%
The first formula is the loop invariant.
%
The second one is a variant expression. 
%
The third one is a real expression bound $g$ and the fourth one an
integer expression $n$.
%
If $g$ is not given then it is interpreted as $g=1$, and the fourth
formula is ignored, otherwise required. $M$ stands for the variables
that may be modified by $c$.

\begin{displaymath}
  \infrule{
    \begin{array}{c}
    \bdHoareSge{c'}{\pre }{\chi \land 
      \forall M.~ (\chi \land 0 \leq e \Rightarrow \neg b)  \land
      \chi \land \neg b \Rightarrow \post}{f} 
    \\[.5ex]
    \forall k.~ \bdHoareSeq{c}{\chi \land b \land e = k}{\chi \land e
      < k}{1}
  \end{array}
}{
    \bdHoareSge{c';\While{b}{c}}{\pre}{\post}{f}
  }\left[\verb+while+\ \chi\ e \right] 
\end{displaymath}
Similarly for (=).

For an arbitrary bound $g$ the following rule generalizes the one
above for lower bounded judgments:
\begin{displaymath}
  \infrule{
    \begin{array}{c}
    \bdHoareSge{c'}{\pre }{\chi \land e \leq n \land 
      \forall M.~ (\chi \land 0 \leq e \Rightarrow \neg b) 
      \land (\chi \land \neg b \Rightarrow \post)}{\frac{f}{g^n}} 
    \\[.5ex]
    \bdHoareSge{c}{\chi \land b}{\chi}{g}
    \\[.5ex]
    \forall k.~ \bdHoareSeq{c}{\chi \land b \land e = k}{e<k}{1}
  \end{array}
}{
    \bdHoareSge{c';\While{b}{c}}{\pre}{\post}{f}
  }\left[\verb+while+\ \chi\ e\ g\ n \right] 
\end{displaymath}

and the folowing one for exact judgments (=):
\begin{displaymath}
  \infrule{
    \begin{array}{c}
    \bdHoareSge{c'}{\pre }{\chi \land e = n \land 
      \forall M.~ (\chi\Rightarrow (0\leq e \Leftrightarrow \neg b)) 
        \land (\chi \land \neg b \Rightarrow \post)}
      {\frac{f}{g^n}}
    \\[.5ex]
    \bdHoareSge{c}{\chi \land b}{\chi}{g}
    \\[.5ex]
    \forall k.~ \bdHoareSeq{c}{\chi \land b \land e = k}{e=k-1}{1}
  \end{array}
}{
    \bdHoareSge{c';\While{b}{c}}{\pre}{\post}{f}
  }\left[\verb+while+\ \chi\ e\ g\ n \right] 
\end{displaymath}


There is no appropriate rule for $(\leq)$.


\subsection{The \texttt{inline} tactic}
%

\subsection{The \texttt{swap} tactic}
%


\section{Tacticals}


\section{Automated Tactics}


%%% Local Variables: 
%%% mode: latex
%%% TeX-master: "easycrypt"
%%% End: 
